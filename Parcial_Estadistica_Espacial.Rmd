---
title: \textbf{Modelos Espaciales de Variogramas}
subtitle: Estadística Espacial
author: "Jose Angel Urquijo Parra"
date: \today

output:
  pdf_document:
    includes:
      in_header:
        - Config.txt     # Configuracion de pie, encabezado y usepackge
---


```{r setup, include=TRUE}
# Configuración general
knitr::opts_chunk$set(
  comment = "",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  eval = TRUE,
  echo = TRUE,
  include = TRUE
)

```


#\textcolor{blue}{Análisis Descriptivo y Exploratorio de los ingresos por Hogares}

```{r}

library(tidyverse)
library(dplyr)

library(spData)
library(gstat)
library(sp)
library(spdep)


library(ggplot2)

library(scales)
library(magrittr)
library(gridExtra)

library(lattice)

library(tmap)
library(sf)
library(tigris)
library(viridis)

```


```{r}
data(columbus)  #Columbus OH spatial analysis data set 

names(columbus) <- make.names(names(columbus), unique = TRUE)


# Los datos columbus estan conformados por informacion espacial que describe una zona geografica 
# Para este trabajo el estudio se centra en ver las distribucion espacial de los ingresos por hogares 
# Estos ingresos estan representados en dolares americanos en la variable INC

summary(columbus$INC)

```

```{r}
coordenada_media <- colMeans(coordinates(columbus)); coordenada_media
```

## histograma regional para visualizar la distribución de ingresos de hogares en columbus

```{r}
plot1 <- ggplot(columbus, aes(x = INC)) + 
  geom_histogram(binwidth = 2, fill = "#69b3a2", size = 1.5,
                 color ="black") + 
  labs(title = "Concentración de ingresos en hogares",
       x = "Concentración", y = "Frecuencia") + theme_minimal()



plot2 <- ggplot(columbus, aes(x = INC)) +
  geom_density(color = "red", size = 0.8) +
  labs(title = "Distribución de la household income (in 1,000 USD)",
       x = "Tasa de household income (in 1,000 USD)",
       y = "Densidad") +
  theme_minimal()

grid.arrange(plot1, plot2, ncol = 2)


```

## \textcolor{blue}{Mapa de cuantiles o box map}


```{r}

coordinates(columbus) <- ~X + Y

columbus$lead_quantile <- cut(columbus$INC, 
                           breaks = quantile(columbus$INC, probs = seq(0, 1, 0.25)), 
                           include.lowest = TRUE, 
                           labels = c("1er Cuartil", "2do Cuartil", "3er Cuartil", "4to Cuartil"))

```

## Mapa de Cuartiles 

```{r}
tm_shape(columbus) +
  tm_dots(col = "lead_quantile", palette = "-RdBu", size = 0.5, title = "Cuantiles de Ingresos") +
  tm_layout(title = "Box Map: Ingreso de Hogares")

```


se puede observar que los hogares con mayor ingreso  se enc

## \textcolor{blue}{Mapa de la Distribución de ingresos por Hogares en Columbus}

```{r}
# Supongamos que columbus es tu data frame
columbus_sf <- st_as_sf(columbus, 
                        coords = c("X", "Y"), 
                        crs = 4269,   # Cambia el CRS si es necesario
                        remove = FALSE)  # Mantén las columnas originales
```


```{r}
# Crear el mapa con tmap
tm_shape(columbus_sf) +
  tm_dots(
    col = "INC",               # Variable para colorear los puntos
    palette = "viridis",        # Paleta de colores
    size = 0.5,                 # Tamaño de los puntos
    title = "Concentracion de Ingresos",  # Título de la leyenda
    style = "quantile",         # Cómo clasificar los datos
    n = 5,                      # Número de clases
    textNA = "No disponible",   # Etiqueta para valores NA
    colorNA = "grey90",         # Color para valores NA
    border.col = "black",       # Color del borde de los puntos
    border.alpha = 0.8          # Transparencia del borde
  ) +
  tm_layout(
    main.title = "Concentracion de Ingresos en Columbus",
    main.title.size = 1.5,
    legend.title.size = 1.5,
    legend.text.size = 0.9,
    legend.position = c("right", "bottom"),
    frame = FALSE,
    inner.margins = c(0.2, 0.005, 0.2, 0.25),
    fontfamily = "sans"
  ) +
  tm_compass(type = "rose", position = c("right", "top")) +  # Añadir brújula
  tm_scale_bar(position = c("left", "bottom"))  # Añadir escala gráfica


```


## \textcolor{blue}{modelo de varianza}

```{r}

variograma <- variogram(log(INC + 1) ~ 1, data = columbus);variograma

```



## \textcolor{blue}{Gráfico de Moran para visualizar la autocorrelación espacial para la variable INC.}

```{r}

# Crear la lista de vecinos y la matriz de pesos espaciales
vecinos <- dnearneigh(coordinates(columbus), 0, 1000)
pesos <- nb2listw(vecinos, style = "W")

# Calcular el I de Moran
moran.plot(columbus$INC, pesos, pch = 16, col = "#2b83ba", 
           main = "Gráfico de Moran: Ingresos por Hogares")

```



# \textcolor{blue}{Después de escoger los parámetros adecuados. Ajuste los modelos vistos en clase tales como Esférico, Exponencial, Gaussiano, Monómico y Pepita Pura. Luego escoja el mejor modelo para el Kriging(estimaciones).}


## \textcolor{blue}{Modelo Exponencial} 

```{r}


modelo_exp <- fit.variogram(variograma, model = vgm(psill = 1, model = "Exp",
                                                    range = 6, nugget = 0.03))


```


```{r}
# Convertir variograma a data frame
variograma_df <- as.data.frame(variograma)

# Generar datos del modelo ajustado
modelo_exp_pred <- variogramLine(modelo_exp, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_exp_df <- as.data.frame(modelo_exp_pred)

```


```{r}
nugget <- modelo_exp$psill[1]  # Valor del nugget
sill <- sum(modelo_exp$psill)  # Meseta (nugget + sill)
range <- modelo_exp$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_exp_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nugget, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sill, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = range, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = range, y = nugget), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = range, y = sill), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nugget), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = range, y = sill), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = range * 1.05, y = nugget, 
           label = paste0("Rango: ", round(range, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = range * 1.05, y = sill, 
           label = paste0("Meseta (Sill): ", round(sill, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nugget * 1.1, 
           label = paste0("Nugget: ", round(nugget, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```

El modelo exponencial ajustado al variograma con un nugget de 0.01, un rango de 4.35 y una meseta de 0.14 indica que la variabilidad a pequeña escala es baja, sugiriendo alta precisión en las mediciones iniciales. Dentro del rango de 4.35 unidades, los puntos de datos están espacialmente correlacionados, mientras que fuera de este rango se considera que no hay correlación significativa. La meseta de 0.14 representa el nivel máximo de variabilidad a gran escala, estableciéndose como el valor total de la varianza en el sistema. En conjunto, estos parámetros reflejan cómo la variable de interés se comporta en términos de dependencia espacial y variabilidad



```{r}
lzn.kriged <- krige(log(INC + 1) ~ 1, columbus, columbus_sf, 
                    model=modelo_exp);head(lzn.kriged)
```

el análisis muestra que las predicciones del kriging ordinario son muy precisas con bajas varianzas, y que hay una variabilidad significativa en los valores predichos a través del área de estudio.

```{r}

lzn.krigedp_d <- lzn.kriged %>%
  st_coordinates() %>%
  as.data.frame() %>%
  cbind(lzn.kriged %>% st_set_geometry(NULL))  # Extraer columnas no espaciales

# Crear el gráfico
ggplot(lzn.krigedp_d, aes(x = X, y = Y)) +
  geom_tile(aes(fill = var1.pred)) +
  coord_equal() +
  scale_fill_gradient(low = "yellow", high = "black") +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  theme_bw()

```

se observa consistentemente que los mayores ingresos  se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo al ingreso.

## \textcolor{blue}{Modelo Gaussiano}

```{r}
modelo_Gau <- fit.variogram(variograma, model = vgm(psill = 1, model = "Gau",
                                                    range = 6, nugget = 0.03))
```



```{r}

# Generar datos del modelo ajustado
modelo_Gau_pred <- variogramLine(modelo_Gau, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_Gau_df <- as.data.frame(modelo_Gau_pred)

```


```{r}
nuggetg <- modelo_Gau$psill[1]  # Valor del nugget
sillg <- sum(modelo_Gau$psill)  # Meseta (nugget + sill)
rangeg <- modelo_Gau$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_Gau_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nuggetg, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sillg, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = rangeg, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = rangeg, y = nuggetg), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = rangeg, y = sillg), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nuggetg), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = rangeg, y = sillg), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = rangeg * 1.05, y = nuggetg, 
           label = paste0("Rango: ", round(rangeg, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = rangeg * 1.05, y = sillg, 
           label = paste0("Meseta (Sill): ", round(sillg, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nuggetg * 1.1, 
           label = paste0("Nugget: ", round(nuggetg, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```


El modelo exponencial ajustado al variograma, con un nugget de 0.04, un rango de 3.72 y una meseta de 0.12, indica que existe una pequeña variabilidad local no explicada por la estructura espacial del modelo, representada por el nugget. La correlación entre las observaciones se mantiene significativa hasta una distancia de 3.72 unidades, más allá de la cual se vuelve muy débil. La meseta de 0.12 refleja la variabilidad máxima entre los puntos a grandes distancias, estableciéndose en ese nivel cuando la influencia espacial se estabiliza. En conjunto, estos parámetros muestran cómo la variabilidad en los datos cambia con la distancia: alta a distancias cortas y estabilizada a distancias mayores.

```{r}
lzn.krigedg <- krige(log(INC + 1) ~ 1, columbus, columbus_sf,
                     model=modelo_Gau);head(lzn.krigedg)
```

El análisis mediante kriging ordinario muestra que las predicciones tienen una alta precisión, con varianzas extremadamente bajas cercanas a cero, indicando alta confianza en las estimaciones. Los valores predichos varían entre 1.700558 y 3.101533, lo que refleja una significativa variabilidad espacial en la variable de interés a través del área delimitada, que abarca desde (35.62, 38) hasta (43.75, 44.07). Los valores más altos se encuentran en (35.62, 42.38) y (43.75, 39.28), mientras que el valor más bajo está en (36.5, 40.52).


```{r}

lzn.krigedp_dg <- lzn.krigedg %>%
  st_coordinates() %>%
  as.data.frame() %>%
  cbind(lzn.krigedg %>% st_set_geometry(NULL))  # Extraer columnas no espaciales

# Crear el gráfico
ggplot(lzn.krigedp_dg, aes(x = X, y = Y)) +
  geom_tile(aes(fill = var1.pred)) +
  coord_equal() +
  scale_fill_gradient(low = "yellow", high = "black") +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  theme_bw()

```

se observa consistentemente que los mayores ingresos  se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo al ingreso.

## \textcolor{blue}{Modelo Monomico}

```{r}
modelo_Pow <- fit.variogram(variograma, model = vgm(psill = 1, model = "Pow",
                                                    range = 1, nugget = 0.3))
```


```{r}

# Generar datos del modelo ajustado
modelo_Pow_pred <- variogramLine(modelo_Pow, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_Pow_df <- as.data.frame(modelo_Pow_pred)

```


```{r}
nuggetp <- modelo_Pow$psill[1]  # Valor del nugget
sillp <- sum(modelo_Pow$psill)  # Meseta (nugget + sill)
rangep <- modelo_Pow$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_Pow_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nuggetp, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sillp, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = rangep, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = rangep, y = nuggetp), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = rangep, y = sillp), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nuggetp), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = rangep, y = sillp), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = rangep * 1.05, y = nuggetp, 
           label = paste0("Rango: ", round(rangep, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = rangep * 1.05, y = sillg, 
           label = paste0("Meseta (Sill): ", round(sillp, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nuggetp * 1.1, 
           label = paste0("Nugget: ", round(nuggetp, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```

Cuando el rango, el nugget y la meseta están en el mismo punto, se concluye que no hay una estructura espacial detectable en los datos a la escala de muestreo utilizada. Este resultado sugiere que podría no ser útil aplicar métodos de interpolación espacial como kriging, ya que no hay correlación espacial significativa que pueda ser aprovechada para mejorar las predicciones en ubicaciones no muestreadas.

```{r}
lzn.krigedpw <- krige(log(INC + 1) ~ 1, columbus, columbus_sf,
                     model=modelo_Pow);head(lzn.krigedpw)
```


Los datos provienen de un análisis de kriging ordinario. La colección contiene 6 puntos con coordenadas específicas y valores predichos (var1.pred) que varían de 1.70 a 3.10. Los valores de variabilidad estimada (var1.var) son muy bajos, con la mayoría cercanos a cero o extremadamente pequeños, lo que indica que la incertidumbre en las predicciones es mínima. Estos puntos están ubicados en un área geográfica con coordenadas de longitud entre 35.62 y 43.75 y latitud entre 38 y 44.07, pero no se especifica un sistema de referencia de coordenadas (CRS). Esto sugiere que los valores predichos tienen una alta precisión para determinar el ingreso de hogares.


```{r}

lzn.krigedpw_df <- as.data.frame(lzn.krigedpw)


lzn.krigedpw_df$X <- st_coordinates(lzn.krigedpw)[,1]
lzn.krigedpw_df$Y <- st_coordinates(lzn.krigedpw)[,2]

# Crear el gráfico
ggplot(lzn.krigedpw_df, aes(x = X, y = Y)) +  # coords.x1 y coords.x2 son las coordenadas
  geom_tile(aes(fill = var1.pred)) +  # var1.pred es el valor predicho
  coord_equal() +
  scale_fill_viridis_c(option = "D") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() +
  labs(
    title = "Resultados del Kriging Ordinario",
    x = "Longitud",
    y = "Latitud",
    fill = "Predicción"
  )

```

se observa consistentemente que las mayores concentraciones de plomo se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo a la acumulación de plomo.

## \textcolor{blue}{Modelo Pepita Pura}


```{r}

# Crear el variograma empírico para la variable zinc
variograma_empirico <- variogram(log(INC + 1) ~ 1, columbus)

# Ajustar un modelo de variograma de pepita pura
model_nugget <- vgm(psill = var(log(columbus$INC + 1)), model = "Nug", range = 0)
variograma_ajustado <- fit.variogram(variograma_empirico, model_nugget)

# Graficar el variograma empírico y el modelo ajustado de manera profesional
plot(variograma_empirico, variograma_ajustado, main = "Variograma Empírico y Modelo Ajustado",
     xlab = "Distancia", ylab = "Semivarianza", pch = 16, col = "blue")

```


```{r}

lzn.krigedp <- krige(log(INC + 1) ~ 1, columbus, columbus_sf,
                     model = variograma_ajustado );head(lzn.krigedp)

```

Los datos representan una colección de puntos geoespaciales obtenidos mediante kriging ordinario, una técnica de interpolación geoespacial. En total, hay 6 puntos con coordenadas específicas y valores predichos (var1.pred) que varían entre 1.70 y 3.10. La variabilidad estimada de estos valores es extremadamente baja, como lo indica el valor cercano a cero para var1.var. Los puntos están distribuidos en un área con coordenadas que abarcan desde 35.62 hasta 43.75 en longitud y desde 38 hasta 44.07 en latitud.


```{r}


lzn.krigedp_dg <- lzn.krigedg %>%
  st_coordinates() %>%
  as.data.frame() %>%
  cbind(lzn.krigedg %>% st_set_geometry(NULL))  # Extraer columnas no espaciales

# Crear el gráfico
ggplot(lzn.krigedp_dg, aes(x = X, y = Y)) +
  geom_tile(aes(fill = var1.pred)) +
  coord_equal() +
  scale_fill_gradient(low = "yellow", high = "black") +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  theme_bw()
```



Al utilizar un modelo de pepita pura (nugget 0), la estructura espacial no muestra correlación espacial alguna más allá de la variabilidad aleatoria o del error de medición. Esto significa que las concentraciones de plomo parecen estar distribuidas de manera completamente aleatoria en el área de estudio, sin una estructura espacial definida que relacione las concentraciones con la ubicación.
























