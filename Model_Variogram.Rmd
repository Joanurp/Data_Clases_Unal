---
title: \textbf{Modelos Espaciales de Variogramas}
subtitle: Estadística Espacial
author: "Jose Angel Urquijo Parra"
date: \today

output:
  pdf_document:
    includes:
      in_header:
        - Config.txt     # Configuracion de pie, encabezado y usepackge
---


```{r setup, include=TRUE}
# Configuración general
knitr::opts_chunk$set(
  comment = "",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  eval = TRUE,
  echo = TRUE,
  include = TRUE
)

```


```{r}
library(gstat)
library(tidyverse)
library(sp)
library(dplyr)
library(gstat)
library(ggplot2)
library(scales)
library(magrittr)
library(gridExtra)
library(sp)
library(lattice)

```



## \textcolor{blue}{Modelo Exponencial} 

```{r}

data("meuse")
data("meuse.grid")

coordinates(meuse) <- ~ x + y
coordinates(meuse.grid) <- ~ x + y

variograma <- variogram(log(lead) ~ 1, data = meuse)
modelo_exp <- fit.variogram(variograma, model = vgm(psill = 1, model = "Exp",
                                                    range = 900, nugget = 0.5))


```


```{r}
# Convertir variograma a data frame
variograma_df <- as.data.frame(variograma)

# Generar datos del modelo ajustado
modelo_exp_pred <- variogramLine(modelo_exp, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_exp_df <- as.data.frame(modelo_exp_pred)

```


```{r}
nugget <- modelo_exp$psill[1]  # Valor del nugget
sill <- sum(modelo_exp$psill)  # Meseta (nugget + sill)
range <- modelo_exp$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_exp_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nugget, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sill, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = range, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = range, y = nugget), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = range, y = sill), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nugget), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = range, y = sill), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = range * 1.05, y = nugget, 
           label = paste0("Rango: ", round(range, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = range * 1.05, y = sill, 
           label = paste0("Meseta (Sill): ", round(sill, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nugget * 1.1, 
           label = paste0("Nugget: ", round(nugget, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```

Correlación Espacial de Alcance Moderado: El rango de 491,29 unidades indica que existe una correlación espacial moderada en los datos. Las observaciones dentro de esta distancia están correlacionadas, lo que es útil para hacer predicciones en áreas no muestreadas.

Predicciones Confiables Dentro del Rango: Debido al bajo nugget y al rango moderado, el modelo de kriging debería proporcionar predicciones confiables en las ubicaciones dentro del rango de 491,29 unidades. Más allá de esta distancia, las predicciones podrían no ser tan precisas debido a la falta de correlación espacial.



```{r}
lzn.kriged <- krige(log(lead) ~ 1, meuse, meuse.grid, 
                    model=modelo_exp);head(lzn.kriged)
```
Variabilidad en Predicciones: Las predicciones varían entre 5.309177 y 5.575890, lo que sugiere que hay variabilidad en los valores estimados en diferentes ubicaciones. Esta variabilidad podría estar reflejando un gradiente o una tendencia espacial en los datos.

Confianza en las Predicciones: La varianza asociada a las predicciones oscila entre 0.1397935 y 0.3014038. Los puntos con predicciones más altas tienden a tener varianzas más bajas, lo que indica una mayor confiabilidad en esos puntos.

Posible Patrón Espacial: La variación en las predicciones y la varianza sugiere que existe una estructura espacial en los datos. Los puntos con menor varianza y mayor predicción podrían estar ubicados en áreas donde la variable de interés tiende a ser más alta, y la predicción es más confiable.

```{r}
plot1 <- meuse %>% as.data.frame %>% 
  ggplot(aes(x, y)) + geom_point(aes(size=lead), color="blue", alpha=3/4) + 
  ggtitle("Lead Concentration (ppm)") + coord_equal() + theme_bw()

plot2 <- lzn.kriged %>% as.data.frame %>%
  ggplot(aes(x=x, y=y)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +
  scale_fill_gradient(low = "yellow", high="red") +
  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +
  theme_bw()


grid.arrange(plot1, plot2, ncol = 2)

```
se observa consistentemente que las mayores concentraciones de plomo se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo a la acumulación de plomo.

## \textcolor{blue}{Modelo Gaussiano}

```{r}
modelo_Gau <- fit.variogram(variograma, model = vgm(psill = 1, model = "Gau",
                                                    range = 900, nugget = 0.5))
```



```{r}
# Convertir variograma a data frame
variograma_df <- as.data.frame(variograma)

# Generar datos del modelo ajustado
modelo_Gau_pred <- variogramLine(modelo_Gau, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_Gau_df <- as.data.frame(modelo_Gau_pred)

```


```{r}
nuggetg <- modelo_Gau$psill[1]  # Valor del nugget
sillg <- sum(modelo_Gau$psill)  # Meseta (nugget + sill)
rangeg <- modelo_Gau$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_Gau_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nuggetg, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sillg, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = rangeg, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = rangeg, y = nuggetg), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = rangeg, y = sillg), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nuggetg), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = rangeg, y = sillg), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = rangeg * 1.05, y = nuggetg, 
           label = paste0("Rango: ", round(rangeg, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = rangeg * 1.05, y = sillg, 
           label = paste0("Meseta (Sill): ", round(sillg, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nuggetg * 1.1, 
           label = paste0("Nugget: ", round(nuggetg, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```
Correlación Espacial: Existe una correlación espacial significativa en los datos hasta una distancia de 414.45 unidades. Esto significa que las observaciones cercanas entre sí (a menos de 414.45 unidades) están correlacionadas, lo que es útil para hacer predicciones en esas áreas.

Relación entre Nugget y Meseta: Dado que el nugget (0.11) es significativamente menor que la meseta (0.54), una parte considerable de la variabilidad total es estructurada (debida a la correlación espacial) y no simplemente aleatoria o debido a errores de medición.

Aplicación del Modelo: El modelo de kriging podría ser muy efectivo para hacer predicciones en ubicaciones no muestreadas dentro del rango de 414.45 unidades. Sin embargo, fuera de este rango, la interpolación puede no ser confiable debido a la falta de correlación espacial.

```{r}
lzn.krigedg <- krige(log(lead) ~ 1, meuse, meuse.grid,
                     model=modelo_Gau);head(lzn.krigedg)
```

Variabilidad en Predicciones: Las predicciones oscilan entre 5.260666 y 5.473433, lo que sugiere que existe cierta variabilidad en los valores estimados en diferentes ubicaciones, aunque la variación no es extrema.

Confianza en las Predicciones: La varianza asociada a las predicciones varía entre 0.1700536 y 0.2464921. Los puntos con predicciones más altas tienden a tener varianzas más bajas, lo que indica que las predicciones son más confiables en esas ubicaciones.

Posible Patrón Espacial: El hecho de que las predicciones y sus varianzas varíen, pero de manera consistente, sugiere que puede haber un patrón espacial detectable en los datos. Este patrón podría ser útil para identificar áreas de mayor o menor interés según el fenómeno que estás estudiando.


```{r}
plot1 <- meuse %>% as.data.frame %>% 
  ggplot(aes(x, y)) + geom_point(aes(size=lead), color="blue", alpha=3/4) + 
  ggtitle("Zinc Concentration (ppm)") + coord_equal() + theme_bw()

plot2 <- lzn.krigedg %>% as.data.frame %>%
  ggplot(aes(x=x, y=y)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +
  scale_fill_gradient(low = "yellow", high="red") +
  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +
  theme_bw()


grid.arrange(plot1, plot2, ncol = 2)

```


se observa consistentemente que las mayores concentraciones de plomo se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo a la acumulación de plomo.


## \textcolor{blue}{Modelo Monomico}

```{r}
modelo_Pow <- fit.variogram(variograma, model = vgm(psill = 1, model = "Pow",
                                                    range = 1, nugget = 0.1))
```


```{r}
# Convertir variograma a data frame
variograma_df <- as.data.frame(variograma)

# Generar datos del modelo ajustado
modelo_Pow_pred <- variogramLine(modelo_Pow, maxdist = max(variograma$dist))

# Convertir a data frame
modelo_Pow_df <- as.data.frame(modelo_Pow_pred)

```


```{r}
nuggetp <- modelo_Pow$psill[1]  # Valor del nugget
sillp <- sum(modelo_Pow$psill)  # Meseta (nugget + sill)
rangep <- modelo_Pow$range[2]   # Rango (del modelo exponencial)

```


```{r}

# Crear el gráfico con anotaciones, etiquetas y puntos de intersección
ggplot() +
  # Gráfico del variograma empírico
  geom_point(data = variograma_df, aes(x = dist, y = gamma), color = "blue", size = 3) +
  
  # Etiquetas de los valores en cada punto del variograma
  geom_text(data = variograma_df, aes(x = dist, y = gamma, label = round(gamma, 2)), 
            vjust = -1, hjust = 0.5, size = 3, color = "blue") +
  
  # Gráfico del modelo ajustado
  geom_line(data = modelo_Pow_df, aes(x = dist, y = gamma), color = "red", size = 1.2) +
  
  # Línea horizontal del nugget
  geom_hline(yintercept = nuggetp, linetype = "dashed", color = "green") +
  
  # Línea horizontal de la meseta (sill)
  geom_hline(yintercept = sillp, linetype = "dashed", color = "purple") +
  
  # Línea vertical del rango
  geom_vline(xintercept = rangep, linetype = "dashed", color = "orange") +
  
  # Puntos de intersección entre las líneas del rango, nugget y sill
  geom_point(aes(x = rangep, y = nuggetp), color = "orange", size = 4, shape = 17) +
  geom_point(aes(x = rangep, y = sillp), color = "orange", size = 4, shape = 17) +   
  geom_point(aes(x = 0, y = nuggetp), color = "green", size = 4, shape = 17) +   
  geom_point(aes(x = rangep, y = sillp), color = "purple", size = 4, shape = 17) +  
  
  # Anotaciones para el rango y meseta, colocadas al lado de las intersecciones
  annotate("text", x = rangep * 1.05, y = nuggetp, 
           label = paste0("Rango: ", round(rangep, 2)), 
           color = "orange", size = 5, hjust = 0) +
  annotate("text", x = rangep * 1.05, y = sillg, 
           label = paste0("Meseta (Sill): ", round(sillp, 2)), 
           color = "purple", size = 5, hjust = 0) +
  
  # Anotación para el nugget, colocada al lado del punto (0, nugget)
  annotate("text", x = 0, y = nuggetp * 1.1, 
           label = paste0("Nugget: ", round(nuggetp, 2)), 
           color = "green", size = 5, hjust = -0.1) +
  
  # Estética y etiquetas
  theme_minimal() +
  labs(title = "Variograma Empírico y Modelo Ajustado",
       x = "Distancia",
       y = "Semivarianza") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12)
  )



```

Cuando el rango, el nugget y la meseta están en el mismo punto, se concluye que no hay una estructura espacial detectable en los datos a la escala de muestreo utilizada. Este resultado sugiere que podría no ser útil aplicar métodos de interpolación espacial como kriging, ya que no hay correlación espacial significativa que pueda ser aprovechada para mejorar las predicciones en ubicaciones no muestreadas.

```{r}
lzn.krigedp <- krige(log(lead) ~ 1, meuse, meuse.grid,
                     model=modelo_Pow);head(lzn.krigedp)
```


Variabilidad en Predicciones: Las predicciones de la variable varían entre 5.342816 y 5.564541, lo que sugiere que hay cierta variabilidad espacial en los valores predichos por el modelo.

Variabilidad en Varianza: La varianza de las predicciones oscila entre 0.1795014 y 0.3131816, lo que indica que la confianza en las predicciones varía según la ubicación. Las predicciones con varianza más baja son más confiables.

Relación entre Predicción y Varianza: En general, los puntos con predicciones más altas tienden a tener varianzas más bajas, lo que sugiere que el modelo es más confiable en estas áreas.


```{r}
plot5 <- meuse %>% as.data.frame %>% 
  ggplot(aes(x, y)) + geom_point(aes(size=lead), color="red", alpha=3/4) + 
  ggtitle("Zinc Concentration (ppm)") + coord_equal() + theme_bw()

plot6 <- lzn.krigedp %>% as.data.frame %>%
  ggplot(aes(x=x, y=y)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +
  scale_fill_gradient(low = "green", high="yellow") +
  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +
  theme_bw()


grid.arrange(plot5, plot6, ncol = 2)

```

se observa consistentemente que las mayores concentraciones de plomo se encuentran en las periferias del área de estudio. Este patrón sugiere que existen factores específicos en estas áreas periféricas que podrían estar contribuyendo a la acumulación de plomo.

## \textcolor{blue}{Modelo Pepita Pura}


```{r}

# Crear el variograma empírico para la variable zinc
variograma_empirico <- variogram(log(lead) ~ 1, meuse)

# Ajustar un modelo de variograma de pepita pura
model_nugget <- vgm(psill = var(log(meuse$lead + 1)), model = "Nug", range = 0)
variograma_ajustado <- fit.variogram(variograma_empirico, model_nugget)

# Graficar el variograma empírico y el modelo ajustado de manera profesional
plot(variograma_empirico, variograma_ajustado, main = "Variograma Empírico y Modelo Ajustado",
     xlab = "Distancia", ylab = "Semivarianza", pch = 16, col = "blue")

```


```{r}

lzn.krigedp <- krige(log(lead) ~ 1, meuse, meuse.grid,
                     model = variograma_ajustado );head(lzn.krigedp)

```

Predicción Constante: Dado que todas las predicciones (var1.pred) son idénticas en todos los puntos, podría ser indicativo de que las concentraciones de plomo no varía mucho en la región estudiada.

Varianza: La varianza relativamente pequeña sugiere que las predicciones son bastante confiables en esas ubicaciones. Sin embargo, dado que las predicciones y las varianzas son constantes, puede que no haya mucha información espacial adicional aportada por el modelo en este caso.

```{r}

lzn.krigedp %>% as.data.frame %>%
  ggplot(aes(x=x, y=y)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +
  scale_fill_gradient(low = "yellow", high="red") +
  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +
  theme_bw()

```


Al utilizar un modelo de pepita pura (nugget 0), la estructura espacial no muestra correlación espacial alguna más allá de la variabilidad aleatoria o del error de medición. Esto significa que las concentraciones de plomo parecen estar distribuidas de manera completamente aleatoria en el área de estudio, sin una estructura espacial definida que relacione las concentraciones con la ubicación.




